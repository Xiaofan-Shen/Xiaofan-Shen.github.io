<!-- 博文的布局-Layout -->
<!DOCTYPE html>
<html>
<head>
<!-- 引入head标签 -->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-sclable=0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="description" content="your web description" />
<meta name="keywords" content="Robot, Machine Learning, Wood Skill, Worldwide Journey" />
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="stylesheet" href="/assets/css/media.css">
<link rel="stylesheet" href="/assets/css/animate.min.css">
<link rel="stylesheet" href="/assets/css/pygments/pygments_default.css">
<link rel="stylesheet" href="/assets/css/github-markdown.css">
<!-- SNS-icon -->
<!-- <script src="//at.alicdn.com/t/font_856428_y9z6nq7zf5.js"></script> -->
<script src="/assets/fonts/font_856428_y9z6nq7zf5.js"></script>

<!-- share.css -->
<link rel="stylesheet" href="/assets/css/share.min.css">
<!-- font -->
<link rel="stylesheet" href="/assets/css/font.css">
<!-- <link href="https://fonts.googleapis.com/css?family=Kaushan+Script|Pacifico|Ubuntu|Roboto+Mono|Source+Sans+Pro" rel="stylesheet"> -->

<!-- Favicon -->
<link href="/assets/profile.jpeg" rel="shortcut icon" />
<link href="/assets/profile.jpeg" rel="apple-touch-icon-precomposed" />
<!-- Android Lolipop Theme Color -->
<!-- <meta name="theme-color" content="#1464FB"> -->
<title>Kalman Filter Implenmented in Python</title>
<!-- 百度统计 -->

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>

<!-- 谷歌分析 -->

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5FZ705XRJX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5FZ705XRJX');
</script>


<!-- Android Lolipop Theme Color -->
<meta name="theme-color" content=" rgb(200,200,200) ">
</head>
<body>

<!-- 顶部锚点 -->
<a id="htmlup" name="htmlup"></a>
<!-- 引入博文顶部选项 -->

<header id="post-header" style="background-color:rgb(200,200,200);">
  <div class="top-center">
      <div class="logo">
          <a href="/" title="my awesome webtitle" style="color: white;">Fan's Robot Lab</a>
      </div>
      <nav class="top-nav">
          <ul>
              
                <li><a href="/about.html" style="color: white;">Homepage</a></li>
              
                <li><a href="/" style="color: white;">My Projects</a></li>
              
                <li><a href="/timeline.html" style="color: white;">Timeline</a></li>
              
                <li><a href="/tags.html" style="color: white;">Tags</a></li>
              
                <li><a href="/mytrip.html" style="color: white;">My Fancy Trip</a></li>
              
          </ul>
      </nav>
      <div id="top-boot">
        <a href="javascript:;" id="boot1" style="display:block;" onclick="document.getElementById('boot-area').style.display='block';document.getElementById('boot1').style.display='none';document.getElementById('boot2').style.display='block';"><img src="/assets/boot_white.png" alt=""></a>
        <a href="javascript:;" id="boot2" style="display: none;" onclick="document.getElementById('boot-area').style.display='none';document.getElementById('boot1').style.display='block';document.getElementById('boot2').style.display='none';"><img src="/assets/boot_white.png" alt=""></a>
      </div>
  </div>

</header>


<!-- 引入移动下拉选项 -->
<div id="boot-area">
    <ul>
        
          <a href="/about.html"><li>Homepage</li></a>
        
          <a href="/"><li>My Projects</li></a>
        
          <a href="/timeline.html"><li>Timeline</li></a>
        
          <a href="/tags.html"><li>Tags</li></a>
        
          <a href="/mytrip.html"><li>My Fancy Trip</li></a>
        
    </ul>
</div>

<!-- 引入博文顶部样式 -->
<!-- 版本一 垃圾 -->
<!-- <div class="wow fadeIn top" data-wow-duration="3.5s" >
    <span class="wow fadeInUp" data-wow-delay="0.2s">Kalman Filter Implenmented in Python</span>
    <span class="wow fadeInUp" data-wow-delay="0.4s"></span>
    <span class="wow fadeInUp" data-wow-delay="0.4s"></span>
    <span class="wow fadeInUp" data-wow-delay="0.6s">作者&nbsp;&nbsp;|&nbsp;&nbsp;true</span>
</div> -->

<!-- 版本二 可切换页面 -->

<div class="post-top" style="background-color:rgb(200,200,200);">
  <!-- 页面宽度大于800px -->
  <div class="left-area">
    
      <a href="javascript:;" class="btn bounceInLeft animated" onmouseover="showLeft();this.style.color='rgb(200,200,200)';" onmouseout="goneLeft();this.style.color='rgba(0,0,0,.2)';"><</a>
      <div id="left-tab" style="display:none;"><span class="left-san"></span><span class="left-main" style="color:rgb(200,200,200);"><sapn class="main">没有上一页咯</sapn></span></div>
    
  </div>
  <div class="post-titlearea">
    <span class="wow fadeInUp" data-wow-delay="0.2s">Kalman Filter Implenmented in Python</span>
    <!-- <span class="wow fadeInUp" data-wow-delay="0.4s"></span> -->
    <!-- <span class="wow fadeInUp" data-wow-delay="0.4s"></span> -->
    <!-- <span class="wow fadeInUp" data-wow-delay="0.6s">作者&nbsp;&nbsp;|&nbsp;&nbsp;true</span> -->
  </div>
  <div class="right-area">
    
      <a href="/2022/09/27/MSc_Project.html" class="btn bounceInRight self-animated" onmouseover="showRight();this.style.color='rgb(200,200,200)';" onmouseout="goneRight();this.style.color='rgba(0,0,0,.2)';">></a>
      <div id="right-tab" style="display:none;"><span class="right-san"></span><span class="right-main" style="color:rgb(200,200,200);"><sapn class="main">Table-scale Dynamic Haptic feedback for virtual reality utilized an object-moving robot</sapn></span></div>
    
  </div>

  <!-- 页面宽度小于800px -->
  <div class="post-changearea">
    
      <a href="javascript:;" class="leftchange" style="border-right: 1px solid rgb(200,200,200);border-bottom: 2px solid rgb(200,200,200);"><span><br>没有上一篇咯</span></a>
    
    
      <a href="/2022/09/27/MSc_Project.html" class="rightchange" style="border-left: 1px solid rgb(200,200,200);border-bottom: 2px solid rgb(200,200,200);"><span>下一篇<br><br>Table-scale Dynamic Haptic feedback for virtual reality utilized an object-moving robot</span></a>
    
  </div>
</div>


<div class="markdown-body fadeInUp animated">

  

  <!-- 文章内容 -->
  <h1 id="kalman-filter">Kalman Filter</h1>

<p>In many real-world applications, such as tracking the position of a moving vehicle, we rely on models to predict the state of a system. However, these predictions are never perfect due to uncertainties and noise in the system. To improve the accuracy of our state estimates, we use a method called the Kalman filtering.</p>

<p>The Kalman filter is an efficient recursive algorithm that estimates the state of a dynamic system from a series of incomplete and noisy measurements.</p>

<p><strong>Modeling a Dynamic System</strong></p>

<p>The dynamics of the system can be represented by the following equations:</p>
<ul>
  <li>The model of the system without noise is:</li>
</ul>

\[\dot{\mathbf x} = \mathbf{Ax}\]

<ul>
  <li>The model of the system with noise is:</li>
</ul>

\[\dot{\mathbf x} = \mathbf{Ax} + \mathbf w\]

<p>Consider any inputs into the system. We assume an input $\mathbf u$, and a linear model matrix $\mathbf B$ is set to convert $\mathbf u$ into the effect on the system.</p>

<ul>
  <li>Including Inputs:</li>
</ul>

\[\dot{\mathbf x} = \mathbf{Ax} + \mathbf{Bu} + \mathbf{w}\]

<p>Where：</p>

<ul>
  <li>
    <p>$\dot{\mathbf x}$ is time derivative of the state $\mathbf x$
, representing the rate of change of the system’s state.</p>
  </li>
  <li>
    <p>$\mathbf{A}$ is the system matrix, which describes the relationship between the state variables.</p>
  </li>
  <li>
    <p>$\mathbf{B}$  is the input matrix, which describes how the input vector $\mathbf{u}$  affects the state variables.</p>
  </li>
  <li>
    <p>$\mathbf{u}$  is the input vector, containing the control inputs to the system.</p>
  </li>
  <li>
    <p>$\mathbf{w}$  is the disturbance vector, representing external disturbances or noise affecting the system.</p>
  </li>
</ul>

<p>These equations form the foundation for modeling dynamic systems, allowing engineers to predict and analyze the system’s behavior under varying conditions and inputs.</p>

<p><strong>State Transition Equation</strong></p>

<p>While continuous-time dynamic models provide theoretical insights into how system states change over time, practical applications demand more specific and actionable models to predict and manage system behaviors at specific moments. This is where the introduction of the state transition equation becomes crucial.</p>

<p>The state transition equation describes how the state of a system evolves over discrete time steps:</p>

\[\mathbf x_k = \mathbf{Fx}_{k-1} + \mathbf B_k\mathbf u_k\]

<p>Where:</p>

<ul>
  <li>
    <p>${\mathbf F}$ is the state transition matrix, which has the ability to transition the state’s value between discrete time steps.</p>
  </li>
  <li>
    <p>$\mathbf{B_k}$ is the control input matrix, which specifies how the control input influences the state transition at time k. It allows flexibility in influence of external inputs in the system.</p>
  </li>
  <li>
    <p>$\mathbf{u_k}$ is the control input vector at time k. It represents external inputs or commands applied to the system at time, which affect the evolution of the state from k-1 to k.</p>
  </li>
</ul>

<p>This equation provides a framework for modeling the temporal evolution of a dynamic system under the influence of external inputs or controls. By adjusting 
F and B, engineers can simulate and analyze how different inputs affect the system’s behavior over time.</p>

<h2 id="python-implementation-of-kalman-filter">Python Implementation of Kalman Filter</h2>

<p>In this case, we use an simple 1D position and velocity example without external control inputs, which system’s state is determined solely by its own dynamics and process noise:</p>

\[\mathbf x_k = \mathbf{Fx}_{k-1}\]

<h4 id="step-1-given-offsers-of-each-variables-in-the-state-vector">Step 1 Given offsers of each variables in the state vector</h4>

<p>These defines the order of the state variables in our vector $\mathbf x$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="c1"># offsets of each variable in the state vector
</span><span class="n">iX</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">iV</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">NUMVARS</span> <span class="o">=</span> <span class="n">iV</span> <span class="o">+</span> <span class="mi">1</span>  
</code></pre></div></div>

<ul>
  <li>‘iX’ and ‘iV’ are the indices for position and velocity in the state vector, respectively.
    <ul>
      <li>in this case, we have 
  \(\mathbf x = \begin{bmatrix}x&amp;v\end{bmatrix}^T\), where $x$ is position, and $v$ is the velocity</li>
    </ul>
  </li>
  <li>‘NUMVARS’ represents the number of variables in the state vector, which is 2 in this case (position and velocity)
    <ul>
      <li>this will be used to initialise the size of our arrays.</li>
    </ul>
  </li>
</ul>

<h4 id="step-2-initialize-the-class-object-instance">Step 2 Initialize the class object instance:</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">KF</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">initial_x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">initial_v</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">accel_variance</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># mean of state GRV
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">NUMVARS</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_x</span><span class="p">[</span><span class="n">iX</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_x</span> 
        <span class="n">self</span><span class="p">.</span><span class="n">_x</span><span class="p">[</span><span class="n">iV</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_v</span>  
        <span class="n">self</span><span class="p">.</span><span class="n">_accel_variance</span> <span class="o">=</span> <span class="n">accel_variance</span>
        <span class="c1"># covariance of state GRV
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_P</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">eye</span><span class="p">(</span><span class="n">NUMVARS</span><span class="p">)</span>

</code></pre></div></div>

<p>init initializes the Kalman filter instance variables:</p>
<ul>
  <li>self._x is the state vector $\mathbf x$, including position and velocity, initialized to a zero vector and then set to the initial position and velocity.</li>
  <li>self._accel_variance is the variance of the acceleration, describing the process noise in the system.</li>
  <li>self._P is the state covariance matrix, initialized to an identity matrix, representing the initial covariance between position and velocity.</li>
</ul>

<h4 id="step-3-prediction-state-prediction-and-covariance-prediction">Step 3 Prediction: state prediction and covariance prediction</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">eye</span><span class="p">(</span><span class="n">NUMVARS</span><span class="p">)</span>
    <span class="n">F</span><span class="p">[</span><span class="n">iX</span><span class="p">,</span> <span class="n">iV</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span> 
    <span class="n">new_x</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_x</span><span class="p">)</span> 
    
    <span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">G</span><span class="p">[</span><span class="n">iX</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dt</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">G</span><span class="p">[</span><span class="n">iV</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span> 
    <span class="n">new_P</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_P</span><span class="p">).</span><span class="nf">dot</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">G</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">G</span><span class="p">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">_accel_variance</span>

    <span class="n">self</span><span class="p">.</span><span class="n">_P</span> <span class="o">=</span> <span class="n">new_P</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">new_x</span>
</code></pre></div></div>

<p><strong>1. State prediction</strong></p>

<p>F is the state transition matrix, we have position and velocity to track, and to describe how the state evolves over a time step dt, $F$ is:</p>

\[\begin{aligned}
\mathbf F &amp;= \begin{bmatrix}1&amp;0\\0&amp;1\end{bmatrix} + \begin{bmatrix}0&amp;1\\0&amp;0\end{bmatrix}\Delta t\\
&amp;= \begin{bmatrix}1&amp;\Delta t\\0&amp;1\end{bmatrix}
\end{aligned}\]

<p>Apply this into $\mathbf x_k= \mathbf{Fx}_{k-1}$ to get the predict new_x, which is:</p>

\[\begin{aligned}
\mathbf x_k &amp;=\begin{bmatrix}1&amp;\Delta t\\0&amp;1\end{bmatrix} \mathbf x_{k-1}
\end{aligned}\]

<p><strong>2. Covariance prediction:</strong>
In addition to predicting the state, it’s essential to predict the covariance because the covariance matrix describes the uncertainty of the state estimation. We denote the predicted covariance matrix as $P_{k+1}$. There are two components in this part:</p>

<ol>
  <li>
    <p><strong>Impact of State Prediction on Covariance:</strong></p>

    <p>During the state prediction (predict) phase, the current state covariance matrix is updated to the predicted state covariance matrix using the state transition matrix F and the process noise covariance matrix 𝑄. This step accounts for the uncertainty in state changes that the system model cannot fully capture.</p>
  </li>
  <li>
    <p><strong>Contribution of Process Noise:</strong></p>

    <p>The process noise covariance matrix Q plays a crucial role in the state prediction by describing the unmodeled dynamic changes in the system and the influence of control inputs. It directly affects the size and structure of the predicted state covariance matrix.</p>
  </li>
</ol>

<p>Based on these two factors, we predict the new state covariance matrix ( P ):</p>

\[\mathbf{P}_{k+1} = F \mathbf{P}_k F^T + Q\]

<p>Recall that Q describes the unmodeled dynamic changes in the system and the influence of control inputs, so it involves G and $\sigma_a^2$:</p>

\[\mathbf{Q} = G G^T \sigma^2_a\]

<p>To sum up:</p>

\[\mathbf{P}_{k+1} = F \mathbf{P}_k F^T + G G^T \sigma^2_a\]

<p>where  $\sigma^2_a $ is the variance of the acceleration noise.</p>

<p><strong>G</strong>
This prediction involves two main components:
For an object moving with constant acceleration a, the position change over a time interval dt can be expressed as:
\(x = x_0 + v_0 \cdot dt + \frac{1}{2} a \cdot dt^2\)</p>

<p>So that, <code class="language-plaintext highlighter-rouge">G[iX] = 0.5 * dt^2</code> and <code class="language-plaintext highlighter-rouge">G[iV] = dt</code> indicate the influence of acceleration noise on position and velocity over the time step $t$ and $G$ matrix is:
The process noise influence matrix ( $G$ ) is:</p>

\[G = \begin{pmatrix} 
0.5 \cdot dt^2 \\ 
dt 
\end{pmatrix}\]

<ul>
  <li>Process Noise Influence Matrix $G$:</li>
  <li>$G$ is the matrix describing the influence of process noise on the system state. Its size matches the state vector.</li>
  <li>The $G$ matrix considers the impact of acceleration noise on both position and velocity.</li>
  <li><code class="language-plaintext highlighter-rouge">G[iX] = 0.5 * dt^2</code> and <code class="language-plaintext highlighter-rouge">G[iV] = dt</code> indicate the influence of acceleration noise on position and velocity over the time step t.</li>
</ul>

<p>Using the G matrix, we predict the new state covariance matrix ( P ):</p>

\[\mathbf{P}_{k+1} = F \mathbf{P}_k F^T + G G^T \sigma^2_a\]

<p>where  $\sigma^2_a $ is the variance of the acceleration noise.</p>

<h4 id="step-4-update">Step 4 Update</h4>

<p>The update step is crucial because it allows the Kalman filter to correct its predictions based on new measurements. Imagine you have a system (like a moving car) and you’re trying to estimate its position and speed. You use a model to predict where the car will be, but your prediction won’t be perfect due to uncertainties (like changes in speed or direction).</p>

<p>Every time you get a new measurement (like a GPS reading), you can use this new information to correct your estimate. This makes your estimation more accurate than just relying on predictions alone.</p>

<p>The update step of the Kalman filter utilizes linear algebra and probability theory to dynamically adjust the state estimate based on real-time measurement data. These mathematical formulas ensure that the filter optimally balances between the system dynamics and measurement uncertainties, providing accurate and reliable state estimation.</p>

<p>Thus, the update step involves correcting the predicted state estimate based on the new measurement. Here’s a detailed explanation of the update process:</p>

<ol>
  <li>
    <p><strong>Calculate Measurement Residual:</strong></p>

    <p>Calculate the measurement residual $y$ , which is the difference between the actual measurement $z$  and the predicted measurement based on the current state estimate</p>

\[y = z - H \mathbf{x}\]

    <p>where:</p>
    <ul>
      <li>$\mathbf{z}$ is the measured measurement.</li>
      <li>$\mathbf{H}$ is the observation matrix that maps the state vector into the measurement space.</li>
      <li>$\mathbf{x}$  is the predicted state vector.</li>
    </ul>
  </li>
  <li>
    <p><strong>Calculate Residual Covariance:</strong></p>

    <p>Compute the residual covariance $S$ , which combines the prediction uncertainty and measurement noise:</p>
  </li>
</ol>

\[S = H \mathbf{P} H^T + R\]

<p>where:</p>
<ul>
  <li>$\mathbf{P}$   is the predicted state covariance matrix.</li>
  <li>$\mathbf{R}$   is the covariance matrix of the measurement noise.</li>
</ul>

<ol>
  <li>
    <p><strong>Compute Kalman Gain:</strong></p>

    <p>The Kalman Gain is a factor that determines how much you should adjust your prediction based on the new measurement. It balances the uncertainty in your prediction against the uncertainty in the measurement. If your prediction is very uncertain but your measurement is very accurate, the Kalman Gain will be higher, meaning you trust the measurement more.
Calculate the Kalman gain $ K $, which determines how much the predicted state estimate is adjusted based on the measurement residual:</p>

\[K = \mathbf{P} H^T (H \mathbf{P} H^T + R)^{-1}\]
  </li>
  <li>
    <p><strong>Update State Estimate:</strong></p>

    <p>Update the state estimate  $\mathbf{x}$  using the Kalman gain and the measurement residual:</p>

\[\mathbf{x}^+ = \mathbf{x} + K y\]

    <p>Adjust your previous state estimate by adding the product of the Kalman Gain and the residual. This step corrects the prediction by bringing it closer to the actual measurement.</p>
  </li>
  <li>
    <p><strong>Update Covariance Matrix:</strong></p>

    <p>Update the covariance matrix $ \mathbf{P} $ to reflect the incorporation of new measurement information:</p>

\[\mathbf{P}^+ = (I - K H) \mathbf{P}\]
  </li>
</ol>

<h3 id="significance-in-applications">Significance in Applications</h3>

<p>The update step enables the Kalman filter to adaptively adjust the state estimate according to real-world measurement data, facilitating precise tracking and prediction of system states. This capability makes the Kalman filter invaluable in real-time applications such as navigation systems, robotics, and sensor data processing.</p>

<p><strong>Implementation of Update in Python:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">meas_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">meas_variance</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="c1"># y = z - H x
</span>        <span class="c1"># S = H P Ht + R
</span>        <span class="c1"># K = P Ht S^-1
</span>        <span class="c1"># x = x + K y
</span>        <span class="c1"># P = (I - K H) * P
</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]).</span><span class="nf">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">meas_value</span><span class="p">])</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">meas_variance</span><span class="p">])</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">H</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_x</span><span class="p">)</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">H</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_P</span><span class="p">).</span><span class="nf">dot</span><span class="p">(</span><span class="n">H</span><span class="p">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">R</span>

        <span class="n">K</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_P</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">H</span><span class="p">.</span><span class="n">T</span><span class="p">).</span><span class="nf">dot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="nf">inv</span><span class="p">(</span><span class="n">S</span><span class="p">))</span>
        
        <span class="n">new_X</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_x</span> <span class="o">+</span> <span class="n">K</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">new_P</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">K</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">H</span><span class="p">)).</span><span class="nf">dot</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_P</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_P</span> <span class="o">=</span> <span class="n">new_P</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">new_X</span>
</code></pre></div></div>

<h2 id="using-the-kf">Using the KF</h2>
<p>Now let’s test the kalman filter implementation</p>

<p>We now create the <code class="language-plaintext highlighter-rouge">main.py</code> script to demonstrates how to use the Kalman Filter to track the position and velocity of an object over time.To better observe the performance of the Kalman Filter, we need to set up the plotting environment and initialize various parameters:</p>

<p><strong>1. Import Libraries and Modules and Set Plotting Environment:</strong></p>

<p>Import the necessary libraries and modules. numpy is used for numerical computations, matplotlib for plotting, and KF is the Kalman Filter implementation.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="n">kf</span> <span class="kn">import</span> <span class="n">KF</span> 
</code></pre></div></div>

<p><strong>2. Initialization and Parameter Setup</strong></p>

<p>Initializing the real position and velocity of the object is necessary to simulate the actual state of the system we want to track. This provides a reference to compare against the filter’s estimates.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">real_x</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">meas_variance</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">real_v</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">kf</span> <span class="o">=</span> <span class="nc">KF</span><span class="p">(</span><span class="n">initial_x</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">initial_v</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">accel_variance</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>3. Simulation Parameters</strong></p>

<p>Defining the noise in the measurements simulates real-world sensor inaccuracies. This helps in testing the filter’s ability to handle and correct noisy data.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DT</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">NUM_STEPS</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">MEAS_EVERY_STEPS</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">mus</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">covs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">real_xs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">real_vs</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">DT</code> is the time step, controlling the interval at which the simulation updates.</li>
  <li><code class="language-plaintext highlighter-rouge">NUM_STEPS</code> is the total number of steps to simulate, determining the duration of the simulation.</li>
  <li><code class="language-plaintext highlighter-rouge">MEAS_EVERY_STEPS</code> defines how often we take measurements, simulating periodic sensor readings.</li>
  <li><code class="language-plaintext highlighter-rouge">mus</code>, <code class="language-plaintext highlighter-rouge">covs</code>, <code class="language-plaintext highlighter-rouge">real_xs</code>, and <code class="language-plaintext highlighter-rouge">real_vs</code> are lists to store the filter’s estimates, covariances, and the true positions and velocities for later analysis and plotting.</li>
</ul>

<p><strong>4. Simulation Loop</strong></p>

<p>To emulate the dynamic behavior of the system over time and to observe how the Kalman Filter performs in real-time tracking of the object’s state, we use simulation loop.  Here’s a detailed explanation of why we need the simulation loop:</p>
<ul>
  <li><strong>Dynamic Behavior Simulation:</strong> 
  In real-world applications, the state of the system (such as the position and velocity of an object) changes continuously over time. The simulation loop allows us to replicate this dynamic behavior in a controlled environment, updating the state of the system at each time step.</li>
  <li><strong>State Prediction and Update:</strong>
  The Kalman Filter operates in two main steps: prediction and update. The simulation loop enables these steps to be executed repeatedly.</li>
  <li><strong>Performance Evaluation:</strong>
  By running the simulation loop over multiple iterations, we can observe how well the Kalman Filter tracks the system’s state over time. This helps in evaluating the filter’s accuracy and responsiveness to changes in the system.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">NUM_STEPS</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
        <span class="n">real_v</span> <span class="o">*=</span> <span class="mf">0.9</span>

    <span class="n">covs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">kf</span><span class="p">.</span><span class="n">cov</span><span class="p">)</span>
    <span class="n">mus</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">kf</span><span class="p">.</span><span class="n">mean</span><span class="p">)</span>
    
    <span class="n">real_x</span> <span class="o">=</span> <span class="n">real_x</span> <span class="o">+</span> <span class="n">DT</span> <span class="o">*</span> <span class="n">real_v</span>

    <span class="n">kf</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">dt</span> <span class="o">=</span> <span class="n">DT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">step</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">step</span> <span class="o">%</span> <span class="n">MEAS_EVERY_STEPS</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">kf</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">meas_value</span> <span class="o">=</span> <span class="n">real_x</span> <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randn</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">meas_variance</span><span class="p">),</span> 
                  <span class="n">meas_variance</span> <span class="o">=</span> <span class="n">meas_variance</span><span class="p">)</span>

    <span class="n">real_xs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">real_x</span><span class="p">)</span>
    <span class="n">real_vs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">real_v</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>5. Plotting</strong></p>

<p>To visually assess the Kalman Filter’s performance in estimating dynamic system states from noisy measurements, plotting is indispensable. It provides a clear comparison between estimated and actual states, visualizes uncertainties, aids in performance evaluation, and facilitates debugging and optimization of the filter implementation.</p>

<p>Apart from the estimated and actual states, we also plot the Confidence Interval of the estimated position/velocity (mean ± 2 standard deviations), which helps us understand the range within which the true velocity is likely to lie with a high degree of confidence. It reflects the uncertainty in our velocity estimation due to measurement variations and model assumptions. Plotting this interval alongside the estimated velocity (mu[1]) allows us to visualize the accuracy and reliability of our velocity predictions throughout the simulation.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Position</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">([</span><span class="n">mu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">mu</span> <span class="ow">in</span> <span class="n">mus</span><span class="p">],</span> <span class="sh">'</span><span class="s">g</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">real_xs</span><span class="p">,</span> <span class="sh">'</span><span class="s">b</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">([</span><span class="n">mu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">mu</span><span class="p">,</span> <span class="n">cov</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">mus</span><span class="p">,</span> <span class="n">covs</span><span class="p">)],</span> <span class="sh">'</span><span class="s">r--</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">([</span><span class="n">mu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">mu</span><span class="p">,</span> <span class="n">cov</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">mus</span><span class="p">,</span> <span class="n">covs</span><span class="p">)],</span> <span class="sh">'</span><span class="s">r--</span><span class="sh">'</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Velocity</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">([</span><span class="n">mu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">mu</span> <span class="ow">in</span> <span class="n">mus</span><span class="p">],</span> <span class="sh">'</span><span class="s">g</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">real_vs</span><span class="p">,</span> <span class="sh">'</span><span class="s">b</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">([</span><span class="n">mu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">mu</span><span class="p">,</span> <span class="n">cov</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">mus</span><span class="p">,</span> <span class="n">covs</span><span class="p">)],</span> <span class="sh">'</span><span class="s">r--</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">([</span><span class="n">mu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">mu</span><span class="p">,</span> <span class="n">cov</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">mus</span><span class="p">,</span> <span class="n">covs</span><span class="p">)],</span> <span class="sh">'</span><span class="s">r--</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="\assets\2024-07-18-KalmanFilter\kalman_filter.png" alt="Description of the image" width="500" height="320" /></p>

<ul>
  <li>
    <p><strong>The first subplot (top) titled ‘Position’ displays：</strong></p>

    <ol>
      <li>Green solid line: Estimated position <code class="language-plaintext highlighter-rouge">mu[0]</code> from the Kalman filter.</li>
      <li>Blue solid line: Real position <code class="language-plaintext highlighter-rouge">real_xs</code>.</li>
      <li>Red dashed lines: Confidence interval of the estimated position <code class="language-plaintext highlighter-rouge">mean ± 2 standard deviations</code>.</li>
    </ol>
  </li>
  <li>
    <p><strong>The second subplot (bottom) titled ‘Velocity’ displays:</strong></p>
    <ol>
      <li>Green solid line: Estimated position <code class="language-plaintext highlighter-rouge">mu[0]</code> from the Kalman filter.</li>
      <li>Blue solid line: Real velocity <code class="language-plaintext highlighter-rouge">real_vs</code>.</li>
      <li>Red dashed lines: Confidence interval of the estimated velocity <code class="language-plaintext highlighter-rouge">mean ± 2 standard deviations</code>.</li>
    </ol>
  </li>
</ul>

<p><strong>Performance Evaluation:</strong></p>

<ul>
  <li>
    <p><strong>Position:</strong></p>

    <p>The predicted positions closely match the true values, indicating excellent performance of the Kalman filter in tracking the system’s position. Additionally, the confidence interval for the estimated velocity is narrow, suggesting high confidence in the velocity estimates and minimal deviation from the actual velocity values. However, there may be noticeable fluctuations near zero, possibly due to inaccuracies in the system model when the position is near stationary or at rest.</p>
  </li>
  <li>
    <p><strong>Velocity:</strong></p>

    <p>Regarding velocity, the predicted values closely approximate the true values overall. However, during changes in velocity, there are noticeable discrepancies. The confidence interval is broader compared to position, indicating lower confidence in velocity estimates and larger potential deviations from actual values. Similar to position, there are significant fluctuations around zero, which are more pronounced for velocity estimates than for position estimates.</p>
  </li>
</ul>

<p><strong>Conclusion</strong></p>

<p>The Kalman filter demonstrates strong performance in tracking the position of the object, with predictions closely matching the true values. The confidence interval for position estimation remains narrow, indicating high confidence in these predictions, except for fluctuations near zero where variability increases.    For velocity, while the Kalman filter accurately tracks changes, there are some deviations observed during rapid changes. The confidence interval for velocity estimates is high, suggesting lower uncertainty in velocity predictions. Same to the position prediction, around zero the fluctuations are more pronounced.  Overall, the Kalman filter effectively reduces noise and provides reliable state estimation for dynamic systems.</p>


  <!-- 引入share模块 -->
  
  <div class="social-share-wrapper">
    <div class="social-share"></div>
  </div>


<!-- share.js -->
<script src="/assets/js/social-share.min.js"></script>
<script>
  socialShare('.social-share', {
    sites: [
      
        'qq'
        ,
        
      
        'wechat'
        ,
        
      
        'weibo'
        ,
        
      
        'twitter'
        ,
        
      
        'facebook'
        
      
    ],
    wechatQrcodeTitle: "分享到微信朋友圈",
    wechatQrcodeHelper: '期待在朋友圈见到这篇文章'
  });
</script>

</div>

<!-- 底部锚点 -->
<a id="htmldown" name="htmldown"></a>
<!-- 引入评论模块 -->
<!-- 


    <section class="post-footer-item comment">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zNDI2OS8xMDgwNg=="></div>
    </section>

    <!-- 来必力City版安装代码 -->
    <script type="text/javascript">
       (function(d, s) {
           var j, e = d.getElementsByTagName(s)[0];

           if (typeof LivereTower === 'function') { return; }

           j = d.createElement(s);
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;

           e.parentNode.insertBefore(j, e);
       })(document, 'script');
    </script>
    <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
    <!-- City版安装代码已完成 -->




 -->
<!-- 引入goto模块 -->
<div class="bounceInRight animated go">
  <a title="顶部切换页面" class="gototop" href="#htmlup" target="_self">
    <div class="box" style="font-family:'ffad_matroregular';">
        Top
    </div>
  </a>
  <a title="底部有livere评论哦" class="gotobottom" href="#htmldown" target="_self">
    <div class="box" style="font-family:'ffad_matroregular';">
        Foot
    </div>
  </a>
</div>

<!-- 引入页面底部模块 -->
<footer id="bottom">
  <br>
  <span>FAN Bot ©
  
  
    2023
    -
  
  2024
  <br>
  <!-- Powered by <a href="https://www.jekyll.com.cn/">Jekyll</a> | <a href="https://github.com/xukimseven/HardCandy-Jekyll">HardCandy-Jekyll</a></span> -->
</footer>


<!-- 引用wow.js的动画效果 -->
<script src="/assets/js/wow.js"></script>
<script>
    var wow = new WOW({
        boxClass: 'wow',
        animateClass: 'animated',
        // offset: 600,
        mobile: true,
        live: true
    });
    wow.init();
</script>
<!-- 页面刷新回到顶部 -->
<script>
    window.onbeforeunload = function(){
        //刷新后页面自动回到顶部
        document.documentElement.scrollTop = 0;  //ie下
        document.body.scrollTop = 0;  //非ie
    }
</script>
<script src="/assets/js/main.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    TeX: {
      equationNumbers: { autoNumber: "all" },
      tagSide: "right"
    },
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    }
  });
</script>

<script 
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" 
  type="text/javascript">

</script>

</body>
</html>
